---
title: "lncRNA analysis of mCRPC He et al Nature Medicine 2021"
output: html_notebook
---
#Load libraries
```{r}

library(tidyverse)
library(Seurat)
library(Hmisc)
library(ggrepel)
library(EnhancedVolcano)
library(msigdbr)
library(EnsDb.Hsapiens.v86)
library(Matrix)
library(ggpubr)
library(tidytext)
library(cowplot)
library(ComplexHeatmap)
library(circlize)

options(ggrepel.max.overlaps = Inf)


```

#Read in scRNAseq data
```{r}
#Read in count data for tumors only in csv - convert to seurat object
anno <- read.table("/Users/ds/Desktop/scRNA_datasets/scp_metadata.tsv", sep = "\t", header = T)  

anno <- anno[-1,]
row.names(anno) <- anno$NAME

tpm <- read.csv(file = "/Users/ds/Desktop/scRNA_datasets/scp_tpm.tsv", sep = "\t", header = TRUE)

tpm <- tpm[!duplicated(tpm$GENE),]
row.names(tpm) <- tpm$GENE
tpm <- tpm[,-1]
colnames(tpm) <- as.character(1:length(anno$NAME) -1)

bmet <- CreateSeuratObject(tpm, meta.data = anno)


bmet <- SetAssayData(object = bmet, slot = "data", new.data = Matrix(as.matrix(log1p(tpm)), sparse = T))
meta <- read.csv(file = "/Users/ds/Desktop/scRNA_datasets/scp_tpm_celltypes.csv")


bmet@meta.data <- cbind(bmet@meta.data, meta)
tx <- read.csv(file = "/Users/ds/Desktop/scRNA_datasets/He_NatureMedicine_tx.csv")
tx <- tx %>% dplyr::filter(has.scRNA == "True")


tx <- inner_join(bmet@meta.data, tx) %>% dplyr::select(c(biopsy, prior.enzalutamide, prior.abiraterone, prior.taxane, prior.platinum, prior.sipuleucel.T))

bmet@meta.data <- cbind(bmet@meta.data, tx)

saveRDS(object = bmet, file = "/Users/ds/Desktop/scRNA_datasets/He_mCRPC.rds")

```



#Download lncRNAs hg38 from cellranger
```{r}

bmet <- readRDS(file = "/Users/ds/Desktop/scRNA_datasets/He_scRNA/He_mCRPC.rds")

all_genes <- read_tsv(file = "/Users/ds/Desktop/projects/data/anno//hg38.genes.meta.tsv")

linc <- all_genes %>% dplyr::filter(gene.biotype == "lncRNA")
pcg <- all_genes %>% dplyr::filter(gene.biotype == "protein_coding")

linc

mat <- GetAssayData(object = bmet)



id <- intersect(row.names(mat), linc$gene.name)




dim(mat[id,])[1] / dim(linc)[1]


DotPlot(object = bmet, features = "LINC00152")

mat["PCAT14",]
Idents(bmet) <- "supercluster.for.LDSC.SEG"




```



#LncRNA markers for cells
```{r}

markers <- FindAllMarkers(object = bmet[row.names(bmet) %in% linc$gene.name,], only.pos = T, verbose = T)
pcg_markers <- FindAllMarkers(object = bmet[row.names(bmet) %in% pcg$gene.name], only.pos = T, verbose = T)

markers %>% dplyr::filter(pct.1 > 0.1 & p_val_adj < 0.1 & avg_log2FC> 1)  %>% dplyr::filter(cluster == 'tumor')


markers <- markers  %>% dplyr::filter(pct.1 > 0.1 & p_val_adj < 0.1 & avg_log2FC> 1) #Filter percent diff, logFC, and adj P value
markers <- markers[!duplicated(markers$gene),]#Filter duplicates



pcg_markers <- pcg_markers %>%  dplyr::filter(pct.1 > 0.1 & p_val_adj < 0.1 & avg_log2FC> 1) 

pcg_markers <- pcg_markers %>%  arrange(-avg_log2FC) %>% group_by(cluster) %>% slice_head(n = 2)   #Filter percent diff, logFC, and adj P value


pcg_markers <- pcg_markers[!duplicated(pcg_markers$gene),]#Filter duplicates

View(pcg_markers)

bmet@assays$RNA@counts

```

#Filter markers using Chen et al
```{r}
valid <- read.table(file = "/Users/ds/Desktop/projects/lncRNA/data/Manual.Marker.modify.txt", header = T)

#Filter prostate
other_markers <- valid %>% dplyr::filter(is.na(Epithelia) & (!is.na(BCell) | !is.na(DC)   | !is.na(Endothelia) | !is.na(Fibroblast) | !is.na(Macrophage) | !is.na(MastCell) | !is.na(Myofib) |  !is.na(Neutrophil) | !is.na(pDC) | !is.na(PlasmaCell) | !is.na(TCell)   )) 
  
other_markers <- other_markers  %>% dplyr::select(-ends_with(".p_val_adj")) %>% gather(key  = "Cell", value = "logFC", -markers.gene) %>% group_by(Cell) %>% dplyr::filter(logFC>1) %>% .$markers.gene %>% unique()



a <- markers  %>% dplyr::filter(cluster == "tumor") %>% dplyr::filter(!gene %in% other_markers) %>% arrange(-avg_log2FC) 

#Filter B cell lineage
other_markers <- valid %>% dplyr::filter( (is.na(BCell) & is.na(PlasmaCell))   & (!is.na(Epithelia) | !is.na(DC)   | !is.na(Endothelia) | !is.na(Fibroblast) | !is.na(Macrophage) | !is.na(MastCell) | !is.na(Myofib) |  !is.na(Neutrophil) | !is.na(pDC) |  !is.na(TCell)   )) 

other_markers <- other_markers  %>% dplyr::select(-ends_with(".p_val_adj")) %>% gather(key  = "Cell", value = "logFC", -markers.gene) %>% group_by(Cell) %>% dplyr::filter(logFC>1) %>% .$markers.gene %>% unique()


b <- markers  %>% dplyr::filter(cluster == "B lineage" ) %>% dplyr::filter(! gene %in% other_markers) %>% arrange(-avg_log2FC) 



#Filter NK/T cell
other_markers <- valid %>% dplyr::filter(is.na(TCell) & (!is.na(Epithelia) | !is.na(DC)   | !is.na(Endothelia) | !is.na(Fibroblast) | !is.na(Macrophage) | !is.na(MastCell) | !is.na(Myofib) |  !is.na(Neutrophil) | !is.na(pDC) | !is.na(PlasmaCell) | !is.na(BCell)   )) 

other_markers <- other_markers  %>% dplyr::select(-ends_with(".p_val_adj")) %>% gather(key  = "Cell", value = "logFC", -markers.gene) %>% group_by(Cell) %>% dplyr::filter(logFC>1) %>% .$markers.gene %>% unique()


c <- markers  %>% dplyr::filter(cluster == "NK/T") %>% dplyr::filter(! gene %in% other_markers) %>% arrange(-avg_log2FC) 


#Filter neutrophil cell
other_markers <- valid %>% dplyr::filter(is.na(Neutrophil) & (!is.na(Epithelia) | !is.na(DC)   | !is.na(Endothelia) | !is.na(Fibroblast) | !is.na(Macrophage) | !is.na(MastCell) | !is.na(Myofib) |  !is.na(TCell) | !is.na(pDC) | !is.na(PlasmaCell) | !is.na(BCell)   )) 

other_markers <- other_markers  %>% dplyr::select(-ends_with(".p_val_adj")) %>% gather(key  = "Cell", value = "logFC", -markers.gene) %>% group_by(Cell) %>% dplyr::filter(logFC>1) %>% .$markers.gene %>% unique()


d <- markers  %>% dplyr::filter(cluster == "neutrophil") %>% dplyr::filter(! gene %in% other_markers) %>% arrange(-avg_log2FC) 


#Filter monocyte/macrophage cell
other_markers <- valid %>% dplyr::filter(is.na(Macrophage) & (!is.na(Epithelia) | !is.na(DC)   | !is.na(Endothelia) | !is.na(Fibroblast) | !is.na(Neutrophil) | !is.na(MastCell) | !is.na(Myofib) |  !is.na(TCell) | !is.na(pDC) | !is.na(PlasmaCell) | !is.na(BCell)   )) 

other_markers <- other_markers  %>% dplyr::select(-ends_with(".p_val_adj")) %>% gather(key  = "Cell", value = "logFC", -markers.gene) %>% group_by(Cell) %>% dplyr::filter(logFC>1) %>% .$markers.gene %>% unique()


e <- markers  %>% dplyr::filter(cluster == "monocyte/macrophage" ) %>% dplyr::filter(! gene %in% other_markers) %>% arrange(-avg_log2FC) 


#Filter erythroid cell
f <- markers  %>% dplyr::filter(cluster == "erythroid" ) %>% arrange(-avg_log2FC) 


filt_markers <- rbind(a,b,c,d,e,f)


```


#Filter markers using Kfoury et al
```{r}
bmcrpc <- readRDS(file = "/Users/ds/Desktop/scRNA_datasets/seurat/Kfoury_bmCRPC_scRNA.rds")


Idents(bmcrpc) <- "cells"
valid_kfoury <-FindAllMarkers(object = bmcrpc[row.names(bmcrpc) %in% linc$gene.name,], only.pos = T, verbose = T)



valid_kfoury <- valid_kfoury  %>% dplyr::filter(pct.1 > 0.1 & p_val_adj < 0.1 & avg_log2FC> 1) %>%  arrange(-avg_log2FC) 
valid_kfoury <- valid_kfoury[!duplicated(valid_kfoury$gene),]#Filter duplicates


#Filter prostate
other_markers <- valid_kfoury %>% dplyr::filter(cluster != "Tumor")  %>% .$gene
a <- filt_markers %>% dplyr::filter(cluster == "tumor") %>% dplyr::filter( !gene %in% other_markers )



#Filter NK/T cells
other_markers <- valid_kfoury %>% dplyr::filter(! cluster %in% c("CTL-1", "CTL-2", "NK", "NKT", "CD4+ Naive" ,"Treg Active","Th1/17","Treg Resting","CD8+ Naive"))  %>% .$gene
b <- filt_markers %>% dplyr::filter(cluster == "NK/T") %>% dplyr::filter( !gene %in% other_markers )

#Filter B lineage cells
other_markers <- valid_kfoury %>% dplyr::filter(! cluster %in% c("Mature B","memBcell" ,"Pro-B","Immature B cells"))  %>% .$gene
c <- filt_markers %>% dplyr::filter(cluster == "B lineage") %>% dplyr::filter( !gene %in% other_markers )

#Filter monocyte/macrophage cells
other_markers <- valid_kfoury %>% dplyr::filter(! cluster %in% c("Mono3" , "mDC"  ,"TIM" ,"TAM" ,"Mono2"  ,"Mono1","Monocyte prog")) %>%  .$gene
d <- filt_markers %>% dplyr::filter(cluster == "monocyte/macrophage") %>% dplyr::filter( !gene %in% other_markers )


#Filter erythroid cells
other_markers <- valid_kfoury %>% dplyr::filter(! cluster %in% c("Erythroid")) %>% .$gene
e <- filt_markers %>% dplyr::filter(cluster == "erythroid") %>% dplyr::filter( !gene %in% other_markers )


#No granulocytes in this dataset
f <- filt_markers %>% dplyr::filter(cluster == "neutrophil")

final_markers <- rbind(a,c,b,f,d,e)


View(final_markers)
```


```{r}
compare_markers <- rbind(dplyr::filter(pcg_markers, cluster == 'tumor'), a,dplyr::filter(pcg_markers, cluster == "B lineage") , c,dplyr::filter(pcg_markers, cluster == "NK/T"),b,dplyr::filter(pcg_markers, cluster == "neutrophil"),f,dplyr::filter(pcg_markers, cluster == "monocyte/macrophage"),d,dplyr::filter(pcg_markers, cluster == "erythroid"),e)




```


#Plot markers
```{r}
pca_lncrna <- final_markers %>%  dplyr::filter(cluster == "tumor") %>% arrange(-avg_log2FC)  %>% .$gene



notpca_lncrna <- final_markers %>% dplyr::filter(!gene %in% pca_lncrna) %>% arrange(-avg_log2FC) %>% .$gene
other_lncrna <- linc %>% dplyr::filter(!gene.name %in% final_markers$gene) %>% .$gene.name
```


```{r}
other_lncrna
linc
mcrpc_rna <- read.table(file = "/Users/ds/Desktop/projects/data/rna/mCRPC_RNA_CPM_genename.txt", header = T)

mcrpc_rna <- mcrpc_rna %>% dplyr::filter(Genename %in% c(pca_lncrna, notpca_lncrna)) %>% mutate(Group = ifelse(Genename %in% pca_lncrna, "Prostate lncRNA", "Non prostate lncRNA")) %>% gather(key = "ID", value = "GEX", -c(Genename, Group)) %>% mutate(GEX = log1p(GEX)) 

mcrpc %>% ggplot(aes(x = Group, y = GEX)) + geom_boxplot()

stat.test <- mcrpc_rna %>% wilcox_test(formula = GEX ~ Group) %>% add_significance()   
p2 <- ggboxplot(mcrpc_rna, x = "Group", y = "GEX", fill = viridis::cividis(10)[5])
stat.test <- stat.test %>% add_xy_position(x = "Group")
p2 <- p2 + 
  stat_pvalue_manual(stat.test, label = "p") +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.1)))
stat.test
```


```{r}

bmet <- ScaleData(object = bmet, features = final_markers$gene)


pdf("/Users/ds/Desktop/plot.pdf", height = 15, width = 10)

DoHeatmap(object = bmet, features = final_markers$gene, assay = "RNA", slot = "scale.data",   )+ theme(axis.text.y = element_text(size = 0)) 
dev.off()


```

#Compare lncRNA markers with PCG markers
```{r}
top <-compare_markers  %>% arrange(-avg_log2FC) %>% group_by(cluster)  %>% dplyr::slice(1:7) %>% .$gene



names(top) <- compare_markers  %>% arrange(-avg_log2FC) %>% group_by(cluster)  %>% dplyr::slice(1:7) %>% .$cluster



pdf("/Users/ds/Desktop/plot.pdf", width = 15, height = 15)
DotPlot(object = bmet, features = top, group.by = "supercluster.for.LDSC.SEG") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + coord_flip()
dev.off()




write.table(x = final_markers, file = "/Users/ds/Desktop/projects/lncRNA/results/final_markers_mCRPC_He.txt", quote = F, sep = "\t", row.names = F, col.names = T)


final_markers <- read.table(file = "/Users/ds/Desktop/projects/lncRNA/results/final_markers_mCRPC_He.txt", header = T, sep = "\t")

```


#Validate markers
```{r}


res <- do.call(rbind, lapply(X = unique(final_markers$cluster), FUN = function(c){
  
  
  query_lncrna <- final_markers %>%  dplyr::filter(cluster == c) %>% arrange(-avg_log2FC)  %>% .$gene
  ae <- AverageExpression(object = bmcrpc, features = query_lncrna, slot = "data") %>%  data.frame() %>% log1p() 
  ae <- ae %>% mutate(Genes = row.names(.), Cluster = c)
  return(ae)

  
} ))



res
mat <-  dplyr::select(res, -c("Genes", "Cluster"))
anno <- dplyr::select(res, c("Genes", "Cluster"))
mat
mat <- mat %>% dplyr::select(c(paste0("RNA.", c(c("Tumor"),c("Mature.B","memBcell" ,"Pro.B","Immature.B.cells"),  c("CTL.1", "CTL.2", "NK", "NKT", "CD4..Naive" ,"Treg.Active","Th1.17","Treg.Resting","CD8..Naive"),c("Mono3" , "mDC"  ,"TIM" ,"TAM" ,"Mono2"  ,"Mono1","Monocyte.prog"), c("Erythroid")))))

mat <- t(scale(t(mat))) %>% data.frame() 
colnames(mat) <- gsub(pattern = "RNA.", replacement = "", x = colnames(mat))

row_ha = rowAnnotation(Cluster = anno$Cluster )
mat
pdf("/Users/ds/Desktop/plot.pdf", width = 10, height = 10)
Heatmap(matrix = mat, left_annotation = row_ha, height = unit(20, "cm"), col = colorRampPalette(c("purple","black", "yellow"))(3), show_column_names = T, cluster_rows = F, cluster_columns = F, na_col = 'black', column_split =as.character(c("A", rep("B", 4),rep("C",9),rep("D", 7), "E"    )), row_split = anno$Cluster, row_names_gp = gpar(fontsize = 5))
dev.off()

nrow(res)/nrow(final_markers)

```


#UMAP Plotting
```{r}


seurat_pipeline <- function(object, ndims, seed, resolution){
  
  #Data already normalized 
    FindVariableFeatures(object = object, nfeatures = 2000) %>% 
    ScaleData() %>%
    RunPCA() %>% 
    RunUMAP(dims = 1:ndims, reduction = "pca") %>% 
    FindNeighbors(reduction = "pca", dims = 1:ndims) %>% 
    FindClusters(resolution = resolution, algorithm = 1, random.seed =seed) %>% 
    return()
  
}


bmet <- seurat_pipeline(object = bmet, ndims = 40, seed = 123, 0.5)

Idents(bmet) <- "supercluster.for.LDSC.SEG"
top

pdf("/Users/ds/Desktop/plot.pdf", width = 10)
FeaturePlot(object = bmet, features = top[seq(1, length(top), 5)], label = T, repel = T)
dev.off()


UMAPPlot(object = bmet, label = T, repel = T)

```



#Create reference for CIBERSORTX GEP estimation (S mode)
```{r}


meta <- meta %>%  mutate(celltype = ifelse(supercluster.for.LDSC.SEG == "NK/T", "NK_T.", ifelse(supercluster.for.LDSC.SEG == "monocyte/macrophage", "monocyte_macrophage.",ifelse(supercluster.for.LDSC.SEG == "B lineage", "B.",ifelse(supercluster.for.LDSC.SEG == "tumor", "tumor.", ifelse(supercluster.for.LDSC.SEG == "erythroid", "erythroid.", supercluster.for.LDSC.SEG)) ) ))) %>% group_by(celltype) %>% mutate(ID = paste0(celltype, 1:n())) 


colnames(tpm) <- meta$ID


reference <- data.frame(Genes = row.names(tpm), tpm)
colnames(reference) <- c("Genes", gsub(x = colnames(reference)[-1], pattern = ".[0-9]*$", replacement = ""))

head(reference)

write.table(reference, file = "/Users/ds/Desktop/He_bulk_reference.txt", quote = F, row.names = F, sep = "\t" )


```

#Plot GEP estimates - see if similar to scRNA data
```{r}
gep <- read.table(file = "/Users/ds/Desktop/projects/lncRNA/results/CIBERSORTxGEP_Job40_GEPs.txt", header = T)
gep <- gep %>% inner_join(y = final_markers, by = c("GeneSymbol"= "gene"))


row.names(gep) <- gep$GeneSymbol
gep <- gep %>% dplyr::select(c("tumor", "B", "NK_T", "neutrophi", "monocyte_macrophage", "erythroid", "cluster", "GeneSymbol"))


gep <- gep %>% arrange(cluster)

mat <- gep  %>% dplyr::select(-c("GeneSymbol", "cluster"))
anno <- gep %>% dplyr::select(c("GeneSymbol", "cluster"))



gep
mat <- t(scale(t(mat))) %>% data.frame() 
mat <- na.omit(mat)

row_ha = rowAnnotation(Cluster = anno[row.names(mat),]$cluster )


pdf("/Users/ds/Desktop/plot.pdf", width = 10, height = 10)
Heatmap(matrix = mat, left_annotation = row_ha, width = unit(10, "cm"), col = colorRampPalette(c("purple","black", "yellow"))(3), show_column_names = T, cluster_rows = F, cluster_columns = F, na_col = 'black', row_split = anno[row.names(mat),]$cluster, column_split = letters[1:6], height = unit(20, 'cm'), row_names_gp = grid::gpar(fontsize = 0) , column_names_gp = gpar(fontsize = 10))
dev.off()




nrow(mat)/nrow(final_markers)


```

#Plot heatmaps for specific lncRNAs
```{r}
anno <- read.table("/Users/ds/Desktop/projects/data/anno/202009_deepRNAseq_sample_full.txt", header =T)


anno
anno <- anno %>% dplyr::select(c(sample_id, wgs_id, biopsy_site, disease_type_SIG_GEX, ID_patient, AR,tumor_purity_rna, RB1 )) 


cf <- read.table("/Users/ds/Desktop/projects/BME_analysis/results/CIBERSORTx_Job33_Adjusted.txt", sep = "\t", header = T)
cf$sample_id <- gsub("\\.", "-", cf$Mixture)
row.names(cf) <- cf$Mixture

cf <- inner_join(x = cf, y = anno, by  = c("sample_id" = "sample_id"))



row.names(cf) <- cf$sample_id


cf <- na.omit(cf)#Omit samples without WGS data


ehmr <- read.csv(file = "/Users/ds/Desktop/projects/lncRNA/data/ehmr.csv")

ehmr <-  ehmr %>% dplyr::filter(type == "HMR" & symbol %in% pca_lncrna) %>% group_by(symbol) %>% arrange(cor) %>% slice(1) %>% mutate(Coord = paste0(chrom, ".", start, ".", end)) 

hmr <- read.table(file = "/Users/ds/Desktop/projects/data/bs/all.mcrpc.hmr.txt", header = T)
hmr <- hmr[!duplicated(hmr$Coord),]
hmr <- hmr %>% merge(ehmr) %>% mutate(HMR = paste0(symbol, ".", type)) %>% dplyr::select(c(HMR, starts_with("DTB")))
row.names(hmr) <- hmr$HMR
hmr <- hmr[-1] %>% t() %>% data.frame() %>% mutate(wgs_id  = gsub(pattern = "\\.", replacement = "-", x = row.names(.)))


cna <- read.table(file = "/Users/ds/Desktop/2018_04_15_matrix_CN_integer_symbol_copycat.txt", header = T)

cna <- cna %>% dplyr::filter(IDENTIFIER %in% pca_lncrna) %>% mutate(CopyNumber = paste0(IDENTIFIER, ".CN"))
row.names(cna) <- cna$CopyNumber
cna <- dplyr::select(cna, -c(CopyNumber, IDENTIFIER)) %>% t() %>% data.frame() %>% mutate(wgs_id  = gsub(pattern = "\\.", replacement = "-", x = row.names(.)))

paste0(pca_lncrna, collapse = " ")

```


```{r}
df <- data.frame(mcrpc_rna[, "cases", drop = F],mcrpc_rna[,c(colnames(mcrpc_rna) %in% pca_lncrna)]) %>% inner_join(cf, by = c("cases" = "sample_id")) %>% merge(hmr) %>% merge(cna)


goi <- c("PCAT14", "SCHLAP1", "COLCA1", "PART1", "PCAT1")
df

df <- df[,c(goi, "cases", "AR", "RB1", paste0(goi, ".HMR"), paste0(goi, ".CN"))] %>% mutate(RB1 = ifelse(RB1 == 0, "Loss", "WT")) %>% mutate(AR = ifelse(AR == 3, "Gain", "WT")) 
df
```


```{r}

df
df <- df %>% arrange(PCAT14)  

row.names(df) <- df$cases

col_fun1 = colorRamp2(c(0, 100), c("grey", "blue"))

col_fun2 = colorRamp2(c(0, 3), c("grey", "purple"))

column_ha = HeatmapAnnotation( PCAT14 = anno_barplot(df[,"PCAT14"]  ), HMR = df[,"PCAT14.HMR"], CNA = df[,"PCAT14.CN"], simple_anno_size = unit(2, "cm"), height = unit(10,"cm"), col = list(PCAT14 = "black", HMR = col_fun1, CNA = col_fun2 ))

pdf("/Users/ds/Desktop/plot.pdf", width = 10, height = 10)
Heatmap(matrix = t(df[,c("RB1", "AR")]), top_annotation = column_ha, height = unit(5, "cm"), col = colorRampPalette(c("darkred","navy", "grey"))(3), show_column_names = F)
dev.off()

df

```


